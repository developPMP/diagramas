graph TD
    %% Frontend Layer
    subgraph "ğŸŒ Frontend Angular"
        A[ğŸ“± Angular SPA<br/>- Components<br/>- Services<br/>- Guards<br/>- Interceptors]
        B[ğŸ”„ Angular Router<br/>- Lazy Loading<br/>- Route Guards]
        C[ğŸ“Š State Management<br/>- NgRx/Akita<br/>- Reactive Forms]
    end

    %% BFF Layer - Backend for Frontend
    subgraph "ğŸ¯ BFF Layer (Backend for Frontend)"
        D[ğŸŒ Angular BFF<br/>- AgregaciÃ³n de datos<br/>- TransformaciÃ³n UI<br/>- OptimizaciÃ³n Web<br/>- Caching especÃ­fico]
    end

    %% API Gateway / Reverse Proxy
    subgraph "ğŸ”— Gateway Layer"
        E[ğŸŒ Nginx/Apache<br/>Reverse Proxy<br/>Load Balancer]
        F[ğŸ” API Gateway<br/>- Authentication<br/>- Rate Limiting<br/>- CORS]
    end

    %% Monolito Moderno
    subgraph "ğŸ—ï¸ Monolito Moderno (Spring Boot)"
        subgraph "ğŸ” Security Layer"
            G[ğŸ›¡ï¸ Entra ID Integration<br/>- OAuth2/OIDC<br/>- JWT Validation<br/>- RBAC from Entra<br/>- SSO Support]
        end
        
        subgraph "ğŸ¯ Controller Layer"
            H[ğŸ“¡ REST Controllers<br/>- @RestController<br/>- @RequestMapping]
            I[ğŸŒ GraphQL Resolver<br/>- Query/Mutation<br/>- Subscription]
        end
        
        subgraph "ğŸ’¼ Business Layer"
            J[âš™ï¸ User Service<br/>- Business Logic<br/>- Validation]
            K[ğŸ“¦ Product Service<br/>- Catalog Management<br/>- Pricing]
            L[ğŸ›’ Order Service<br/>- Order Processing<br/>- Workflow]
            M[ğŸ’° Payment Service<br/>- Payment Gateway<br/>- Transactions]
        end
        
        subgraph "ğŸ“‚ Data Access Layer"
            N[ğŸ—ƒï¸ JPA Repositories<br/>- Spring Data<br/>- Custom Queries]
            O[ğŸ“‹ DTO Mappers<br/>- MapStruct<br/>- Converters]
        end
    end

    %% Database Layer
    subgraph "ğŸ’¾ Persistence Layer"
        P[(ğŸ—„ï¸ PostgreSQL<br/>Primary Database)]
        Q[(ğŸ“Š Redis Cache<br/>Session Store)]
        R[ğŸ“ File Storage<br/>S3/MinIO]
    end

    %% External Services
    subgraph "ğŸŒ External Services"
        S[ğŸ“§ Email Service<br/>SendGrid/SES]
        T[ğŸ’³ Payment Gateway<br/>Stripe/PayPal]
        U[ğŸ“± Push Notifications<br/>Firebase/OneSignal]
    end

    %% Flujos de comunicaciÃ³n
    A -->|"1. Login Request"| EntraID[â˜ï¸ Entra ID<br/>Authentication]
    EntraID -->|"2. JWT Token"| A
    
    A -->|"3. HTTP/HTTPS + JWT<br/>Optimized Calls"| D
    B --> A
    C --> A
    
    D -->|"4. Validate JWT + Aggregate"| E
    E -->|"Proxy Pass"| F
    F -->|"Internal API Calls + JWT"| G
    
    G --> H
    G --> I
    
    H -->|"Business Logic"| J
    H -->|"Business Logic"| K
    H -->|"Business Logic"| L
    H -->|"Business Logic"| M
    
    I -->|"Business Logic"| J
    I -->|"Business Logic"| K
    I -->|"Business Logic"| L
    I -->|"Business Logic"| M
    
    J -->|"Data Access"| N
    K -->|"Data Access"| N
    L -->|"Data Access"| N
    M -->|"Data Access"| N
    
    N -->|"Entity Mapping"| O
    
    N -->|"JDBC/JPA"| P
    N -->|"Cache"| Q
    M -->|"File Upload"| R
    
    M -->|"Email"| S
    M -->|"Payment"| T
    J -->|"Notifications"| U

    %% Estilos
    classDef angular fill:#dd0031,color:#ffffff,stroke:#dd0031
    classDef bff fill:#f06292,color:#ffffff,stroke:#e91e63
    classDef gateway fill:#ff9800,color:#ffffff,stroke:#e68900
    classDef security fill:#4caf50,color:#ffffff,stroke:#388e3c
    classDef controller fill:#2196f3,color:#ffffff,stroke:#1976d2
    classDef business fill:#9c27b0,color:#ffffff,stroke:#7b1fa2
    classDef data fill:#607d8b,color:#ffffff,stroke:#455a64
    classDef database fill:#795548,color:#ffffff,stroke:#5d4037
    classDef external fill:#ff5722,color:#ffffff,stroke:#d84315
    classDef entraid fill:#0078d4,color:#ffffff,stroke:#106ebe
    
    class A,B,C angular
    class D bff
    class E,F gateway
    class G security
    class H,I controller
    class J,K,L,M business
    class N,O data
    class P,Q,R database
    class S,T,U external
    class EntraID entraid